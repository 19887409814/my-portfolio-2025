name: ğŸ–¼ï¸ è‡ªåŠ¨å›¾ç‰‡å¤„ç†ä¸Šä¼ å·¥ä½œæµ

# è§¦å‘æ¡ä»¶ï¼šå½“ /data/ ç›®å½•ä¸‹æœ‰æ–°å›¾ç‰‡æ–‡ä»¶è¢«æ¨é€æ—¶
on:
  push:
    paths:
      - 'data/**/*.{jpg,jpeg,png,gif,webp}'
    branches:
      - main
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  image-processing:
    runs-on: ubuntu-latest
    name: ğŸ–¼ï¸ å¤„ç†å’Œç§»åŠ¨å›¾ç‰‡æ–‡ä»¶
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2  # è·å–æœ€è¿‘çš„æäº¤ä»¥ä¾¿æ£€æµ‹å˜æ›´
        
      # æ­¥éª¤2: è®¾ç½®ç¯å¢ƒå˜é‡å’Œå®‰è£…ä¾èµ–
      - name: ğŸ”§ è®¾ç½®ç¯å¢ƒ
        run: |
          echo "ğŸ” æ£€æŸ¥å·¥ä½œç›®å½•ç»“æ„..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la
          
          echo ""
          echo "ğŸ“‚ æ£€æŸ¥ /data/ ç›®å½•..."
          if [ -d "data" ]; then
            echo "data ç›®å½•å­˜åœ¨ï¼Œå†…å®¹:"
            ls -la data/
          else
            echo "data ç›®å½•ä¸å­˜åœ¨ï¼Œå°†åˆ›å»º..."
            mkdir -p data
          fi
          
          echo ""
          echo "ğŸ“‚ æ£€æŸ¥ /public/ ç›®å½•..."
          if [ ! -d "public" ]; then
            echo "åˆ›å»º public ç›®å½•ç»“æ„..."
            mkdir -p public/images
          else
            echo "public ç›®å½•å·²å­˜åœ¨ï¼Œæ£€æŸ¥ images å­ç›®å½•..."
            if [ ! -d "public/images" ]; then
              echo "åˆ›å»º public/images ç›®å½•..."
              mkdir -p public/images
            fi
          fi
          
          echo ""
          echo "ğŸ“Š è®¾ç½®æƒé™..."
          chmod -R 755 public/
          ls -la public/
      
      # æ­¥éª¤3: å®‰è£…å›¾ç‰‡å¤„ç†ä¾èµ–
      - name: ğŸ› ï¸ å®‰è£…ImageMagickå’Œä¾èµ–
        run: |
          echo "ğŸ” æ£€æŸ¥ç³»ç»ŸåŒ…ç®¡ç†å™¨..."
          
          # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get update
          
          # å®‰è£…ImageMagickå’Œå…¶ä»–å›¾ç‰‡å¤„ç†å·¥å…·
          echo "ğŸ“¦ å®‰è£…ImageMagick..."
          sudo apt-get install -y imagemagick identify jpegoptim pngquant optipng
          
          # éªŒè¯å®‰è£…
          echo "âœ… éªŒè¯ImageMagickå®‰è£…..."
          convert --version
          identify --version
          
          # å®‰è£…exiftoolï¼ˆç”¨äºè·å–å›¾ç‰‡å…ƒæ•°æ®ï¼‰
          echo "ğŸ“¦ å®‰è£…exiftool..."
          sudo apt-get install -y libimage-exiftool-perl
          
          echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆï¼"
      
      # æ­¥éª¤4: æŸ¥æ‰¾å’Œç§»åŠ¨å›¾ç‰‡æ–‡ä»¶
      - name: ğŸ“ æŸ¥æ‰¾å’Œå¤„ç†å›¾ç‰‡æ–‡ä»¶
        run: |
          echo "ğŸ” å¼€å§‹å¤„ç†å›¾ç‰‡æ–‡ä»¶..."
          echo "å½“å‰æ—¶é—´æˆ³: $(date +'%Y%m%d_%H%M%S')"
          
          # è®¾ç½®æ—¶é—´æˆ³
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          echo "æ—¶é—´æˆ³å˜é‡: $TIMESTAMP"
          
          # æŸ¥æ‰¾dataç›®å½•ä¸­çš„å›¾ç‰‡æ–‡ä»¶
          echo ""
          echo "ğŸ“‹ æŸ¥æ‰¾å›¾ç‰‡æ–‡ä»¶..."
          find data/ -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" -o -name "*.webp" \) 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶"
          
          # å¤„ç†æ¯ä¸ªå›¾ç‰‡æ–‡ä»¶
          echo ""
          echo "ğŸ”„ å¼€å§‹å¤„ç†å›¾ç‰‡æ–‡ä»¶..."
          MOVED_FILES=0
          
          for file in data/*.{jpg,jpeg,png,gif,webp}; do
            if [ -f "$file" ]; then
              echo ""
              echo "ğŸ“· å¤„ç†æ–‡ä»¶: $file"
              
              # è·å–æ–‡ä»¶åå’Œæ‰©å±•å
              filename=$(basename "$file")
              extension="${filename##*.}"
              basename="${filename%.*}"
              
              # ç”Ÿæˆæ–°æ–‡ä»¶å
              new_name="${TIMESTAMP}_${basename}.${extension}"
              target_path="public/images/$new_name"
              
              echo "ğŸ·ï¸  åŸå§‹æ–‡ä»¶å: $filename"
              echo "ğŸ·ï¸  æ–°æ–‡ä»¶å: $new_name"
              echo "ğŸ“ ç›®æ ‡è·¯å¾„: $target_path"
              
              # è·å–å›¾ç‰‡ä¿¡æ¯
              if command -v identify &> /dev/null; then
                echo "ğŸ“Š å›¾ç‰‡ä¿¡æ¯:"
                identify "$file" || echo "æ— æ³•è·å–å›¾ç‰‡ä¿¡æ¯"
              fi
              
              # è·å–æ–‡ä»¶å¤§å°
              file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
              echo "ğŸ“ æ–‡ä»¶å¤§å°: $file_size bytes"
              
              # ç§»åŠ¨æ–‡ä»¶
              echo "ğŸ“¦ ç§»åŠ¨æ–‡ä»¶..."
              cp "$file" "$target_path"
              
              # éªŒè¯ç§»åŠ¨ç»“æœ
              if [ -f "$target_path" ]; then
                echo "âœ… æ–‡ä»¶ç§»åŠ¨æˆåŠŸ: $target_path"
                
                # ä»æºç›®å½•åˆ é™¤æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦å†³å®šæ˜¯å¦ä¿ç•™åŸæ–‡ä»¶ï¼‰
                # rm "$file"
                # echo "ğŸ—‘ï¸  å·²åˆ é™¤åŸæ–‡ä»¶: $file"
                
                MOVED_FILES=$((MOVED_FILES + 1))
                
                # æ˜¾ç¤ºç§»åŠ¨åçš„æ–‡ä»¶ä¿¡æ¯
                if command -v identify &> /dev/null; then
                  echo "ğŸ“Š ç§»åŠ¨åå›¾ç‰‡ä¿¡æ¯:"
                  identify "$target_path" || echo "æ— æ³•è·å–ç§»åŠ¨åå›¾ç‰‡ä¿¡æ¯"
                fi
              else
                echo "âŒ æ–‡ä»¶ç§»åŠ¨å¤±è´¥: $target_path"
              fi
            fi
          done
          
          echo ""
          echo "ğŸ“ˆ å¤„ç†ç»Ÿè®¡:"
          echo "ğŸ“¦ ç§»åŠ¨çš„æ–‡ä»¶æ•°é‡: $MOVED_FILES"
          echo "ğŸ“‚ public/images/ ç›®å½•å†…å®¹:"
          ls -la public/images/ || echo "ç›®å½•ä¸ºç©º"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "MOVED_FILES=$MOVED_FILES" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
      
      # æ­¥éª¤5: å›¾ç‰‡ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
      - name: âš¡ ä¼˜åŒ–å›¾ç‰‡æ–‡ä»¶
        run: |
          echo "ğŸš€ å¼€å§‹ä¼˜åŒ–å›¾ç‰‡æ–‡ä»¶..."
          OPTIMIZED_FILES=0
          
          for file in public/images/*.{jpg,jpeg,png,gif,webp}; do
            if [ -f "$file" ]; then
              echo ""
              echo "âš¡ ä¼˜åŒ–æ–‡ä»¶: $file"
              
              # è·å–åŸå§‹æ–‡ä»¶å¤§å°
              original_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
              
              # æ ¹æ®æ–‡ä»¶ç±»å‹è¿›è¡Œä¼˜åŒ–
              case "$file" in
                *.jpg|*.jpeg)
                  # JPEGä¼˜åŒ–
                  echo "ğŸ¨ ä¼˜åŒ–JPEGæ–‡ä»¶..."
                  if command -v jpegoptim &> /dev/null; then
                    jpegoptim --max=85 "$file" --quiet || echo "jpegoptim ä¼˜åŒ–å¤±è´¥"
                  fi
                  ;;
                *.png)
                  # PNGä¼˜åŒ–
                  echo "ğŸ¨ ä¼˜åŒ–PNGæ–‡ä»¶..."
                  if command -v pngquant &> /dev/null; then
                    pngquant --output "$file" --force --speed 1 "$file" || echo "pngquant ä¼˜åŒ–å¤±è´¥"
                  fi
                  if command -v optipng &> /dev/null; then
                    optipng -o2 "$file" || echo "optipng ä¼˜åŒ–å¤±è´¥"
                  fi
                  ;;
              esac
              
              # è·å–ä¼˜åŒ–åæ–‡ä»¶å¤§å°
              optimized_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
              
              # è®¡ç®—å‹ç¼©æ¯”ä¾‹
              if [ "$original_size" -gt 0 ]; then
                reduction=$((original_size - optimized_size))
                percentage=$(( (reduction * 100) / original_size ))
                echo "ğŸ“Š ä¼˜åŒ–ç»“æœ: åŸå§‹: ${original_size}B â†’ ä¼˜åŒ–å: ${optimized_size}B (å‡å°‘: ${reduction}B, ${percentage}%)"
              fi
              
              OPTIMIZED_FILES=$((OPTIMIZED_FILES + 1))
            fi
          done
          
          echo ""
          echo "ğŸ“ˆ ä¼˜åŒ–ç»Ÿè®¡:"
          echo "âš¡ ä¼˜åŒ–çš„æ–‡ä»¶æ•°é‡: $OPTIMIZED_FILES"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "OPTIMIZED_FILES=$OPTIMIZED_FILES" >> $GITHUB_ENV
      
      # æ­¥éª¤6: æäº¤æ›´æ”¹
      - name: ğŸ“ é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          echo "âš™ï¸ é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          echo "âœ… Gitç”¨æˆ·ä¿¡æ¯é…ç½®å®Œæˆ"
      
      # æ­¥éª¤7: æäº¤å’Œæ¨é€æ›´æ”¹
      - name: ğŸš€ æäº¤å’Œæ¨é€æ›´æ”¹
        run: |
          echo "ğŸ” æ£€æŸ¥æ›´æ”¹çŠ¶æ€..."
          git status
          
          echo ""
          echo "ğŸ“Š æ·»åŠ æ–‡ä»¶åˆ°Git..."
          git add public/images/ || echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¦æ·»åŠ çš„å›¾ç‰‡æ–‡ä»¶"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            echo ""
            echo "ğŸ“ åˆ›å»ºæäº¤..."
            TIMESTAMP=${{ env.TIMESTAMP }}
            COMMIT_MESSAGE="ğŸ–¼ï¸ è‡ªåŠ¨å¤„ç†å›¾ç‰‡æ–‡ä»¶ ($TIMESTAMP)
            
            ğŸ“¦ ç§»åŠ¨æ–‡ä»¶: ${{ env.MOVED_FILES }} ä¸ª
            âš¡ ä¼˜åŒ–æ–‡ä»¶: ${{ env.OPTIMIZED_FILES }} ä¸ª
            â° å¤„ç†æ—¶é—´: $(date)
            ğŸ¤– æäº¤è€…: GitHub Actions"
            
            git commit -m "$COMMIT_MESSAGE"
            echo "âœ… æäº¤åˆ›å»ºæˆåŠŸ"
            
            echo ""
            echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
            git push origin main 2>/dev/null || git push origin master 2>/dev/null || echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é…ç½®æƒé™"
            
            echo "âœ… æ¨é€å®Œæˆ"
          fi
      
      # æ­¥éª¤8: ç”Ÿæˆå¤„ç†æŠ¥å‘Š
      - name: ğŸ“‹ ç”Ÿæˆå¤„ç†æŠ¥å‘Š
        run: |
          echo ""
          echo "ğŸ“‹ ========== å›¾ç‰‡å¤„ç†å·¥ä½œæµæŠ¥å‘Š =========="
          echo "â° æ‰§è¡Œæ—¶é—´: $(date)"
          echo "ğŸ·ï¸  å·¥ä½œæµ: ${{ github.workflow }}"
          echo "ğŸŒ ä»“åº“: ${{ github.repository }}"
          echo "ğŸ“Š åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ”— æäº¤: ${{ github.sha }}"
          echo ""
          echo "ğŸ“Š å¤„ç†ç»Ÿè®¡:"
          echo "ğŸ“¦ ç§»åŠ¨çš„æ–‡ä»¶æ•°é‡: ${{ env.MOVED_FILES }}"
          echo "âš¡ ä¼˜åŒ–çš„æ–‡ä»¶æ•°é‡: ${{ env.OPTIMIZED_FILES }}"
          echo "â° æ—¶é—´æˆ³: ${{ env.TIMESTAMP }}"
          echo ""
          echo "ğŸ“‚ public/images/ ç›®å½•å†…å®¹:"
          if [ -d "public/images" ]; then
            ls -la public/images/ || echo "ç›®å½•ä¸ºç©º"
            
            # æ˜¾ç¤ºæ–‡ä»¶è¯¦ç»†ä¿¡æ¯
            echo ""
            echo "ğŸ“Š æ–‡ä»¶è¯¦ç»†ä¿¡æ¯:"
            for file in public/images/*; do
              if [ -f "$file" ]; then
                file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "unknown")
                file_name=$(basename "$file")
                echo "ğŸ“· $file_name ($file_size bytes)"
              fi
            done
          else
            echo "public/images ç›®å½•ä¸å­˜åœ¨"
          fi
          echo ""
          echo "ğŸ”— æŸ¥çœ‹å¤„ç†çš„å›¾ç‰‡:"
          echo "ğŸŒ GitHubä»“åº“: https://github.com/${{ github.repository }}"
          echo "ğŸ“ Imagesç›®å½•: https://github.com/${{ github.repository }}/tree/main/public/images"
          echo "ğŸ“‹ ========== æŠ¥å‘Šç»“æŸ =========="
      
      # æ­¥éª¤9: é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: ğŸ“¢ å·¥ä½œæµå®Œæˆé€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ å›¾ç‰‡å¤„ç†å·¥ä½œæµæ‰§è¡ŒæˆåŠŸï¼"
            echo "âœ… æˆåŠŸç§»åŠ¨ ${{ env.MOVED_FILES }} ä¸ªå›¾ç‰‡æ–‡ä»¶"
            echo "âš¡ æˆåŠŸä¼˜åŒ– ${{ env.OPTIMIZED_FILES }} ä¸ªå›¾ç‰‡æ–‡ä»¶"
          else
            echo "âŒ å›¾ç‰‡å¤„ç†å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
          fi
          echo ""
          echo "ğŸ“Š çŠ¶æ€: ${{ job.status }}"
          echo "ğŸ”— å·¥ä½œæµé“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"